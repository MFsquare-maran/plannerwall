{% extends "base.html" %}
{% set title = "Board" %}

{% block content %}
<div class="card tasks-card">
  <div class="tasks-bar">
    <div class="tasks-title">
      <div class="tasks-h1">Offene Tasks</div>
      <div class="tasks-sub">Planner Board</div>
    </div>

    <!-- RIGHT SIDE (alles rechts aligned) -->
    <div class="tasks-right" aria-label="Right side widgets: Abfahrten + Status">
      <!-- Departures box -->
      <div class="topline-departure" aria-label="Abfahrten">
        <div class="departure-row header">
          <span class="col-line">ðŸšŒ</span>
          <span class="col-line">Linie</span>
          <span class="col-dest">Ziel</span>
          <span class="col-time">Abfahrt </span>
        </div>

        <div class="departures-list">
          {% if departures %}
            {% for dep in departures %}
              <div class="departure-row line-departure">
                <span class="col-image"></span>
                <span class="col-line">{{ dep.line }}</span>
                <span class="col-dest">{{ dep.direction }}</span>
                <span class="col-time">{{ dep.mins }} min</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="line-departure">Keine Abfahrten.</div>
          {% endif %}
        </div>
      </div>

      <!-- Weitere Infoanzeigen wie Wetter und Aare ... -->
      <div class="tasks-info-right" aria-label="Status: KW/Zeit, Aare, Wetter">
        <div class="w-kwtime">
          <div class="w-kw">ðŸ•– KW {{ iso_week }}</div>
          <div class="w-datetime">
            <div class="w-date">| {{ weekday }} | {{ current_date }} | {{ current_time }}</div>
          </div>
        </div>

        <!-- Aare -->
        <div class="w-aare" title="Aare">
          <div class="w-label">
            <span class="w-icon" aria-hidden="true">ðŸŒŠ</span>
            <span class="w-main-text">
              {% if aare is mapping %}
                {{ aare.get('label', 'Aare') }}
              {% else %}
                {{ aare.label if aare and aare.label is defined else 'Aare' }}
              {% endif %}
            </span>
          </div>

          <div class="w-value">
            {% if aare %}
              {% if aare is mapping %}
                {% if aare.get('temp_c') is not none %}
                  {{ "%.1f"|format(aare.get('temp_c')) }}Â°C
                {% elif aare.get('temp') %}
                  {{ aare.get('temp') }}
                {% else %}
                  â€“
                {% endif %}
              {% else %}
                {% if aare.temp_c is defined and aare.temp_c is not none %}
                  {{ "%.1f"|format(aare.temp_c) }}Â°C
                {% elif aare.temp is defined and aare.temp %}
                  {{ aare.temp }}
                {% else %}
                  â€“
                {% endif %}
              {% endif %}
            {% else %}
              â€“
            {% endif %}
          </div>
        </div>

        <!-- Wetter -->
        <div class="w-pack" title="Wetter">
          <div class="w-weather-label">
            <span class="w-icon" aria-hidden="true">
              {% if weather is mapping %}
                {{ weather.get('icon', '') }}
              {% else %}
                {{ weather.icon if weather.icon is defined else '' }}
              {% endif %}
            </span>
            <span class="w-main-text">
              {% if weather is mapping %}
                {{ weather.get('location', 'Wetter') }}
              {% else %}
                {{ weather.location if weather.location is defined else 'Wetter' }}
              {% endif %}
            </span>
          </div>

          <div class="w-weather-temp">
            {% if weather %}
              {% if weather is mapping %}
                {% if weather.get('temp_c') is not none %}
                  {{ "%.1f"|format(weather.get('temp_c')) }}Â°C
                {% elif weather.get('temp') %}
                  {{ weather.get('temp') }}
                {% else %}
                  â€“
                {% endif %}
              {% else %}
                {% if weather.temp_c is defined and weather.temp_c is not none %}
                  {{ "%.1f"|format(weather.temp_c) }}Â°C
                {% elif weather.temp is defined and weather.temp %}
                  {{ weather.temp }}
                {% else %}
                  â€“
                {% endif %}
              {% endif %}
            {% else %}
              â€“
            {% endif %}
          </div>

          <div class="w-weather-sub">
            {% if weather %}
              {% if weather is mapping %}
                {% if weather.get('wind_kmh') is not none %}
                  Wind {{ "%.0f"|format(weather.get('wind_kmh')) }} km/h
                {% else %}
                  &nbsp;
                {% endif %}
              {% else %}
                {% if weather.wind_kmh is defined and weather.wind_kmh is not none %}
                  Wind {{ "%.0f"|format(weather.wind_kmh) }} km/h
                {% else %}
                  &nbsp;
                {% endif %}
              {% endif %}
            {% else %}
              &nbsp;
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOARD CONTENT -->
<div class="grid">
  <div class="card">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:10px;">
      <h2 style="margin:0; font-size:16px; font-weight:900;">Externe AuftrÃ¤ge</h2>
      <span class="badge">{{ groups['extern']|length }}</span>
    </div>
    <div class="scroll-area">
      {% set rows = groups['extern'] %}
      {% include "_table.html" %}
    </div>
  </div>

  <div class="card">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:10px;">
      <h2 style="margin:0; font-size:16px; font-weight:900;">Interne AuftrÃ¤ge</h2>
      <span class="badge">{{ groups['intern']|length }}</span>
    </div>
    <div class="scroll-area">
      {% set rows = groups['intern'] %}
      {% include "_table.html" %}
    </div>
  </div>
</div>

{% if debug_show and debug_notes|length %}
  <div class="card">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px;">
      <h2 style="margin:0; font-size:16px; font-weight:900;">Debug</h2>
      <span class="badge">aktiv</span>
    </div>
    <div class="scroll-area" style="max-height:240px;">
      <pre style="white-space:pre-wrap; margin:0;">{{ "\n".join(debug_notes) }}</pre>
    </div>
  </div>
{% endif %}

<script>
  setInterval(() => window.location.reload(), 10000);
</script>
{% endblock %}
